{% load static %}

<!doctype html>
<html lang="en">
  <head>
    <title>Lesson</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Font Awesome 6.0.0-beta3 CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <link rel="stylesheet" href="{% static 'new_template/css/style.css' %}">

    <style>
        /* Additional styles for a cleaner scrollbar */
        .chatbot-body {
            overflow-y: auto;
        }
    
        .chatbot-body::-webkit-scrollbar {
            width: 8px;
        }
    
        .chatbot-body::-webkit-scrollbar-thumb {
            background-color: #5b9bd5; /* Softer blue */
            border-radius: 10px;
        }
    
        .chatbot-body::-webkit-scrollbar-track {
            background: #e9ecef; /* Light gray for track */
        }
    
        /* Hide the chatbot using visibility and opacity */
        .closed {
            visibility: hidden;
            opacity: 0;
            height: 0; /* Set height to 0 when closed */
            transition: all 0.3s ease; /* Smooth transition for visibility */
        }
    
        /* When the chatbot is open */
        .chatbot-container {
            visibility: visible;
            opacity: 1;
            height: auto; /* Auto height when opened */
            transition: all 0.3s ease; /* Smooth transition for visibility */
        }
    
        /* Style adjustments for the message bubbles */
        .chat-message {
            padding: 10px;
            border-radius: 20px;
            margin-bottom: 10px;
            max-width: 70%; /* Limit the width of messages */
            word-wrap: break-word; /* Break long words */
            position: relative; /* Allow positioning of the timestamp */
        }
    
        .chat-message-user {
            background-color: #a4d7f2; /* Light blue for user messages */
            color: black; /* Darker text for readability */
            align-self: flex-end; /* Align user messages to the right */
        }
    
        .chat-message-bot {
            background-color: #f7f7f7; /* Light gray for bot messages */
            color: black; /* Darker text for readability */
            align-self: flex-start; /* Align bot messages to the left */
        }
    
        /* Style for the timestamp */
        .timestamp {
            display: block; /* New line for the timestamp */
            font-size: 0.8em; /* Smaller font size for the timestamp */
            color: #555; /* Darker gray for the timestamp */
            margin-top: 5px; /* Space above the timestamp */
        }
    
        /* Style adjustments for the footer input */
        .input-group {
            padding: 10px 0; /* Space around input group */
        }
    
        /* Ensure the card is responsive */
        .chatbot-container {
            max-width: 400px; /* Set a max-width for the chatbot */
            width: 100%; /* Full width on smaller screens */
        }
    
        .lesson-content {
            line-height: 1.5; /* Adjust the line height as needed */
            margin: 0; /* Remove any default margin */
            padding: 0; /* Remove any default padding */
        }
    
        .lesson-content p {
            margin: 0; /* Remove default margin from paragraphs */
            padding: 0; /* Remove padding from paragraphs */
        }
    
        .lesson-content img {
            max-width: 100%;  /* Make images responsive */
            height: auto;     /* Maintain aspect ratio */
            display: block;   /* Remove bottom space */
            margin: 0 auto;  /* Center the image */
        }
    
        /* Header Styles */
        #chatbot-header {
            background-color: #003d66; /* Darker blue for header */
            color: white; /* White text for header */
        }

        .floating-alert {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050; /* Ensure it appears above other elements */
            width: 300px; /* Adjust width as needed */
        }

        

    </style>
    
  </head>
  <body>
    <audio id="notificationSound" src="{% static 'notification/notif_update.mp3' %}" preload="auto"></audio>

    <div class="wrapper d-flex align-items-stretch">
      <!-- NAVBAR  -->
      {% include 'navbar/navbar_students.html' %}

      <!-- Page Content  -->
      <div id="content" class="p-4 p-md-5">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <button type="button" id="sidebarCollapse" class="btn btn-primary">
                    <i class="fa fa-bars"></i>
                    <span class="sr-only">Toggle Menu</span>
                </button>
                <button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <i class="fa fa-bars"></i>
                </button>
    
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <span class="navbar-text mr-3">Logged in as {{ request.user.username }}</span>
                        </li>

                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fa fa-bell"></i>
                                <span class="badge bg-danger" id="notificationCount">{{ notifications|length }}</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationDropdown" style="width: 350px; max-height: 400px; overflow-y: auto;">
                                <li class="dropdown-header d-flex justify-content-between align-items-center">
                                    <strong>Notifications</strong>
                                    <a class="text-muted" href="#" id="markAllAsRead">Mark all as read</a>
                                </li>
                                <div id="notificationList">
                                    {% for notification in notifications %}
                                    <li class="dropdown-item {% if not notification.is_read %}bg-light{% endif %}" style="white-space: normal; word-wrap: break-word; word-break: break-word;">
                                        <p class="mb-1">
                                            <strong>From: {{ notification.sender.username }}</strong><br>
                                            {{ notification.message }}
                                        </p>
                                        <small class="text-muted">{{ notification.created_at }}</small>
                                    </li>
                                    {% empty %}
                                    <li class="dropdown-item">No notifications.</li>
                                    {% endfor %}
                                </div>
                            </ul>
                        </li>

                    </ul>
                </div>
            </div>
        </nav>
    
        <div class="container mt-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="card-title display-6">
                        {{ lesson.name|safe }}
                    </h2>
                    <hr>
                    <div class="lesson-content my-4" style="line-height: 1.5; margin: 0; padding: 0;">
                        <div class="fs-6" style="margin: 0; padding: 0;">
                            {{ lesson.content|safe }}
                        </div>
                    </div>
        
                    {% if lesson.file %}
                        <div class="d-grid gap-2">
                            <a href="{{ lesson.file.url }}" class="btn btn-outline-primary btn-lg">Download Attached File</a>
                        </div>
                    {% endif %}
        
                    <hr>
        
                    <!-- Button Row -->
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-4">
                        {% if lesson not in user.userprofile.read_lessons.all %}
                            <form action="{% url 'mark_done_reading' lesson.id %}" method="POST" class="m-0">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success btn-lg">Done Reading</button>
                            </form>
                        {% else %}
                            <button class="btn btn-success btn-lg" disabled>You've marked this lesson as done</button>
                        {% endif %}
        
                        {% if all_done_in_category %}
                            <a href="{% url 'categories_activity' %}" class="btn btn-warning btn-lg">All Lessons Completed! Go to Practice Test Activity</a>
                        {% endif %}
        
                        {% if next_lesson %}
                            <a href="{% url 'lesson_detail' next_lesson.id %}" class="btn btn-primary btn-lg">Next Lesson</a>
                        {% endif %}
                    </div>
        
                    <p class="card-text text-muted text-end mt-3">
                        <strong>Published on:</strong> <small>{{ lesson.publish_date }}</small>
                    </p>
                </div>
            </div>
        </div>
        
        
        
        
        
        
        
        

        <section class="home-section">
            <div class="main-content">
                <div class="container">
                    <div class="chatbot-container card shadow-lg border-0 mt-5 closed" id="chatbot-container">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center" id="chatbot-header">
                            <span>Chatbot - <span id="chatbot-user-name">{{ user.username }}</span></span>
                            <button type="button" class="btn-close btn-close-white" aria-label="Close" id="chatbot-close"></button>
                        </div>
                        <div class="card-body p-4 chatbot-body d-flex flex-column" id="chatbot-body" style="height: 400px; max-height: 400px; overflow-y: auto;">
                            <!-- Chat messages will appear here -->
                        </div>
                        <div class="card-footer p-3 bg-light">
                            <div class="input-group">
                                <input type="text" class="form-control" id="chatbot-input" placeholder="Type a message..." aria-label="Type a message...">
                                <button class="btn btn-primary" id="chatbot-send">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>


        {% include 'notification/student_notification.html' %}
        

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const chatbotContainer = document.getElementById('chatbot-container');
                const chatbotHeader = document.getElementById('chatbot-header');
                const chatbotClose = document.getElementById('chatbot-close');
                const chatbotBody = document.getElementById('chatbot-body');
                const chatbotInput = document.getElementById('chatbot-input');
                const chatbotSend = document.getElementById('chatbot-send');
            
                let isChatbotClosed = true; // Ensure chatbot starts in a closed state
            
                // Toggle chatbot visibility on header click
                chatbotHeader.addEventListener('click', function () {
                    if (isChatbotClosed) {
                        openChatbot();
                    } else {
                        closeChatbot();
                    }
                });
            
                // Close chatbot when close button is clicked
                chatbotClose.addEventListener('click', function (event) {
                    event.stopPropagation(); // Prevent triggering the header click event
                    closeChatbot();
                });
            
                // Function to close the chatbot
                function closeChatbot() {
                    chatbotContainer.classList.add('closed');
                    isChatbotClosed = true; // Mark the chatbot as closed
                }
            
                // Function to open the chatbot
                function openChatbot() {
                    chatbotContainer.classList.remove('closed');
                    isChatbotClosed = false; // Mark the chatbot as open
                }
        
                // Send message to the chatbot
                chatbotSend.addEventListener('click', function () {
                    sendMessage();
                });
        
                // Send message on Enter key
                chatbotInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
        
                function showSpinner() {
                    const spinner = document.createElement('div');
                    spinner.classList.add('spinner-border', 'text-primary');
                    spinner.setAttribute('role', 'status');
                    spinner.innerHTML = '<span class="visually-hidden">Loading...</span>';
                    chatbotBody.appendChild(spinner);
                }
        
                function hideSpinner() {
                    const spinner = chatbotBody.querySelector('.spinner-border');
                    if (spinner) {
                        chatbotBody.removeChild(spinner);
                    }
                }
        
                function sendMessage() {
                    const message = chatbotInput.value;
                    if (message.trim() === '') return;
                
                    // Append user message to the chat body with an immediate timestamp (for instant feedback)
                    const instantTimestamp = new Date().toISOString();
                    appendMessage('You', message, instantTimestamp);
                
                    // Clear the input field
                    chatbotInput.value = '';
                
                    // Show spinner while waiting for the chatbot response
                    showSpinner();
                
                    // Send the message to the server
                    fetch("{% url 'chatbot_response' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: 'message=' + encodeURIComponent(message)
                    })
                    .then(response => response.json())
                    .then(data => {
                        hideSpinner();
                        appendMessage('Chatbot', data.message, data.timestamp);  // Use the timestamp from the server response
                    })
                    .catch(error => {
                        hideSpinner();
                        console.error('Error:', error);
                        appendMessage('Chatbot', 'Sorry, I encountered an error.');
                    });
                }
        
                function appendMessage(sender, message, timestamp) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('chat-message', sender === 'You' ? 'chat-message-user' : 'chat-message-bot');
                
                    // Create a span for the sender name
                    const senderName = document.createElement('strong');
                    senderName.innerText = `${sender}: `;
                    senderName.classList.add('sender-name');
                
                    // Create a span for the message content
                    const messageContent = document.createElement('span');
                    messageContent.innerText = message;
                    messageContent.classList.add('message-content');
                
                    // Append the sender name and message content to the message div
                    messageDiv.appendChild(senderName);
                    messageDiv.appendChild(messageContent);
                
                    // Create a timestamp element
                    const timestampElement = document.createElement('span');
                    timestampElement.classList.add('timestamp');
                    const formattedTimestamp = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    timestampElement.innerText = formattedTimestamp; // Format timestamp here
                    messageDiv.appendChild(timestampElement);
                
                    // Append the message div to the chatbot body
                    chatbotBody.appendChild(messageDiv);
                
                    // Scroll to the latest message
                    chatbotBody.scrollTop = chatbotBody.scrollHeight;
                }
        
                // Fetch and display chat history
                fetchChatHistory();
        
                function fetchChatHistory() {
                    fetch("{% url 'get_chat_history' %}", {
                        method: 'GET',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.chat_history) {
                            data.chat_history.forEach(interaction => {
                                appendMessage('You', interaction.user_message, interaction.timestamp);  // Pass the timestamp
                                appendMessage('Chatbot', interaction.bot_response, interaction.timestamp); // Pass the timestamp for bot response
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching chat history:', error);
                    });
                }
            });
        </script> 
        
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {  
            // WebSocket URL (Use wss if the site uses HTTPS)
        const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        let notificationSocket = createWebSocketConnection();
        let reconnectInterval;
        
        // Function to establish WebSocket connection
        function createWebSocketConnection() {
            const socket = new WebSocket(
                `${wsProtocol}://${window.location.host}/ws/notifications/`
            );

            // Handle incoming WebSocket messages
            socket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                const notificationList = document.getElementById('notificationList');
                if (!notificationList) return; // Exit if notification list is not available

                // Create new notification element
                const newNotification = document.createElement('li');
                newNotification.classList.add('dropdown-item');
                newNotification.style.whiteSpace = 'normal';  // Ensure text wraps
                newNotification.style.wordBreak = 'break-word'; // Prevent horizontal scroll

                newNotification.innerHTML = `
                    <p class="mb-1">
                        <strong>From: ${data.sender}</strong><br>${data.message}
                    </p>
                    <small class="text-muted">${new Date(data.created_at).toLocaleString()}</small>
                `;

                // Add new notification to the top of the list
                notificationList.prepend(newNotification);

                // Update the notification count
                const notificationCount = document.getElementById('notificationCount');
                if (notificationCount) {
                    notificationCount.textContent = parseInt(notificationCount.textContent) + 1;
                }

                // Play the notification sound
                const notificationSound = document.getElementById('notificationSound');
                if (notificationSound) {
                    notificationSound.play();
                }
            };

            // WebSocket onclose event with reconnection logic
            socket.onclose = function (e) {
                console.error('Notification socket closed unexpectedly. Attempting to reconnect...');
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(function () {
                        console.log('Reconnecting WebSocket...');
                        notificationSocket = createWebSocketConnection();
                    }, 5000);  // Try to reconnect every 5 seconds
                }
            };

            // On successful connection, clear the reconnect interval
            socket.onopen = function () {
                console.log('WebSocket connection established.');
                clearInterval(reconnectInterval);
                reconnectInterval = null;  // Reset the interval
            };

            return socket;
        }

        // Mark all notifications as read
        document.getElementById('markAllAsRead')?.addEventListener('click', function (e) {
            e.preventDefault();
            fetch("{% url 'mark_all_notifications_as_read' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            }).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the notification count to 0
                        const notificationCount = document.getElementById('notificationCount');
                        if (notificationCount) {
                            notificationCount.innerText = '0';
                        }
                        // Remove highlight from the notification list
                        document.querySelectorAll('#notificationList .dropdown-item').forEach(item => {
                            item.classList.remove('bg-light');
                        });
                    }
                }).catch(error => {
                    console.error('Error marking notifications as read:', error);
                });
        });

        // Update notification count on page load
        function updateNotificationCount() {
            fetch("{% url 'notifications_count' %}")
                .then(response => response.json())
                .then(data => {
                    const notificationCount = document.getElementById('notificationCount');
                    if (notificationCount) {
                        notificationCount.innerText = data.unread_count;
                    }
                }).catch(error => {
                    console.error('Error updating notification count:', error);
                });
        }

        // Call the function to initialize count on page load
        updateNotificationCount();
    });
    </script>
    
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <script src="{% static 'new_template/js/jquery.min.js' %}"></script>
      <script src="{% static 'new_template/js/popper.js' %}"></script>
      <script src="{% static 'new_template/js/bootstrap.min.js' %}"></script>
      <script src="{% static 'new_template/js/main.js' %}"></script>
  </body>
</html>




