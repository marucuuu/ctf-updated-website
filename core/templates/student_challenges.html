{% load static %}

<!doctype html>
<html lang="en">
  <head>
  	<title>Challenges</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Font Awesome 6.0.0-beta3 CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <link rel="stylesheet" href="{% static 'new_template/css/style.css' %}">
  </head>
  <body>
    <audio id="notificationSound" src="{% static 'notification/notif_update.mp3' %}" preload="auto"></audio>

		<div class="wrapper d-flex align-items-stretch">

      <!-- NAVBAR  -->
      {% include 'navbar/navbar_students.html' %}


        <!-- Page Content  -->
      <div id="content" class="p-4 p-md-5">

        <nav class="navbar navbar-expand-lg navbar-light bg-light">
          <div class="container-fluid">

            <button type="button" id="sidebarCollapse" class="btn btn-primary">
              <i class="fa fa-bars"></i>
              <span class="sr-only">Toggle Menu</span>
            </button>
            <button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <i class="fa fa-bars"></i>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="nav navbar-nav ml-auto">
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                  <ul class="nav navbar-nav ml-auto">
                      <li class="nav-item">
                          <span class="navbar-text mr-3">Logged in as {{ request.user.username }}</span>
                      </li>
                      <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa fa-bell"></i>
                            <span class="badge bg-danger" id="notificationCount">{{ notifications|length }}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationDropdown" style="width: 350px; max-height: 400px; overflow-y: auto;">
                            <li class="dropdown-header d-flex justify-content-between align-items-center">
                                <strong>Notifications</strong>
                                <a class="text-muted" href="#" id="markAllAsRead">Mark all as read</a>
                            </li>
                            <div id="notificationList">
                                {% for notification in notifications %}
                                <li class="dropdown-item {% if not notification.is_read %}bg-light{% endif %}" style="white-space: normal; word-wrap: break-word; word-break: break-word;">
                                    <p class="mb-1">
                                        <strong>From: {{ notification.sender.username }}</strong><br>
                                        {{ notification.message }}
                                    </p>
                                    <small class="text-muted">{{ notification.created_at }}</small>
                                </li>
                                {% empty %}
                                <li class="dropdown-item">No notifications.</li>
                                {% endfor %}
                            </div>
                        </ul>
                    </li>
                  </ul>
              </div>  
              </ul>
            </div>
          </div>
        </nav>

        {% block content %}
    <div class="container mt-5">
        <h2 class="mb-4 text-center">Explore Available Challenges</h2>

        <div class="mb-4 bg-dark text-white p-4">
            <p><strong>Instructions:</strong></p>
            <p>For the Individual Challenges, you'll be working on these tasks by yourself. Make sure to complete the related lessons first, as the challenges will only become available once you’ve finished the necessary lessons.</p>
            <p>The Team Challenges are meant to be tackled with your teammates. These challenges are only visible to team members, so make sure you’re collaborating with your group to solve them together.</p>
        </div>

        <!-- Individual Challenges Section -->
        <h3 class="mt-5">Individual Challenges</h3>
        <p class="mb-4">These challenges are designed for you to tackle alone. Complete related activities to unlock them.</p>
        {% for category, category_info in categories.individual.items %}
            <h4 class="mb-3 text-muted">{{ category|upper }} ({{ category_info.lesson_count }} lessons)</h4>
            <div class="row">
                {% for item in category_info.challenge_list %}
                    <div class="col-md-4 mb-4">
                        <div class="card shadow-sm h-100 
                            {% if item.challenge in completed_challenges %}
                                bg-light border border-success
                            {% else %}
                                bg-light
                            {% endif %}">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">{{ item.challenge.name }}</h5>
                                <p class="card-text">{{ item.challenge.description|truncatewords:20 }}</p>  <!-- Shortened description -->
                                <div class="mt-auto">
                                    <a href="{% url 'challenge_detail' item.challenge.id %}" class="btn btn-primary btn-block">View Challenge</a>
                                </div>
                            </div>
                            <div class="card-footer text-muted d-flex justify-content-between align-items-center">
                                <span class="text-small">
                                    {% if item.challenge.deadline %}
                                        <i class="fas fa-calendar-alt"></i> Deadline: {{ item.challenge.deadline|date:"F j, Y g:i a" }}
                                    {% else %}
                                        <i class="fas fa-calendar-alt"></i> No deadline
                                    {% endif %}
                                </span>
                                {% if item.challenge in completed_challenges %}
                                    <span class="badge bg-success text-light">Completed</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <p class="col-12">No individual challenges available in this category.</p>
                {% endfor %}
            </div>
        {% endfor %}

        <!-- Team Challenges Section -->
        {% if user_team %}
            <h3 class="mt-5">Team Challenges</h3>
            <p class="mb-4">Collaborate with your teammates to solve these challenges. Make sure you’re part of a team to access them.</p>
            {% for category, category_info in categories.team.items %}
                <h4 class="mb-3 text-muted">{{ category|upper }} ({{ category_info.lesson_count }} lessons)</h4>
                <div class="row">
                    {% for item in category_info.challenge_list %}
                        <div class="col-md-4 mb-4">
                            <div class="card shadow-sm h-100 
                                {% if item.team_completed %}
                                    bg-light border border-success
                                {% else %}
                                    bg-light
                                {% endif %}">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">{{ item.challenge.name }}</h5>
                                    <p class="card-text">{{ item.challenge.description|truncatewords:20 }}</p>  <!-- Shortened description -->
                                    <div class="mt-auto">
                                        <a href="{% url 'challenge_detail' item.challenge.id %}" class="btn btn-primary btn-block">View Challenge</a>
                                    </div>
                                </div>
                                <div class="card-footer text-muted d-flex justify-content-between align-items-center">
                                    <span class="text-small">
                                        {% if item.challenge.deadline %}
                                            <i class="fas fa-calendar-alt"></i> Deadline: {{ item.challenge.deadline|date:"F j, Y g:i a" }}
                                        {% else %}
                                            <i class="fas fa-calendar-alt"></i> No deadline
                                        {% endif %}
                                    </span>
                                    {% if item.team_completed %}
                                        <span class="badge bg-success text-light">Completed</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <p class="col-12">No team challenges available in this category.</p>
                    {% endfor %}
                </div>
            {% endfor %}
        {% else %}
            
        {% endif %}
    </div>
{% endblock %}






    <script>
      document.addEventListener('DOMContentLoaded', function () {  
          // WebSocket URL (Use wss if the site uses HTTPS)
const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
let notificationSocket = createWebSocketConnection();
let reconnectInterval;

// Function to establish WebSocket connection
function createWebSocketConnection() {
  const socket = new WebSocket(
      `${wsProtocol}://${window.location.host}/ws/notifications/`
  );

  // Handle incoming WebSocket messages
  socket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      const notificationList = document.getElementById('notificationList');
      if (!notificationList) return; // Exit if notification list is not available

      // Create new notification element
      const newNotification = document.createElement('li');
      newNotification.classList.add('dropdown-item');
      newNotification.style.whiteSpace = 'normal';  // Ensure text wraps
      newNotification.style.wordBreak = 'break-word'; // Prevent horizontal scroll

      newNotification.innerHTML = `
          <p class="mb-1">
              <strong>From: ${data.sender}</strong><br>${data.message}
          </p>
          <small class="text-muted">${new Date(data.created_at).toLocaleString()}</small>
      `;

      // Add new notification to the top of the list
      notificationList.prepend(newNotification);

      // Update the notification count
      const notificationCount = document.getElementById('notificationCount');
      if (notificationCount) {
          notificationCount.textContent = parseInt(notificationCount.textContent) + 1;
      }

      // Play the notification sound
      const notificationSound = document.getElementById('notificationSound');
      if (notificationSound) {
          notificationSound.play();
      }
  };

  // WebSocket onclose event with reconnection logic
  socket.onclose = function (e) {
      console.error('Notification socket closed unexpectedly. Attempting to reconnect...');
      if (!reconnectInterval) {
          reconnectInterval = setInterval(function () {
              console.log('Reconnecting WebSocket...');
              notificationSocket = createWebSocketConnection();
          }, 5000);  // Try to reconnect every 5 seconds
      }
  };

  // On successful connection, clear the reconnect interval
  socket.onopen = function () {
      console.log('WebSocket connection established.');
      clearInterval(reconnectInterval);
      reconnectInterval = null;  // Reset the interval
  };

  return socket;
}

// Mark all notifications as read
document.getElementById('markAllAsRead')?.addEventListener('click', function (e) {
  e.preventDefault();
  fetch("{% url 'mark_all_notifications_as_read' %}", {
      method: 'POST',
      headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
      },
      body: JSON.stringify({})
  }).then(response => response.json())
      .then(data => {
          if (data.success) {
              // Update the notification count to 0
              const notificationCount = document.getElementById('notificationCount');
              if (notificationCount) {
                  notificationCount.innerText = '0';
              }
              // Remove highlight from the notification list
              document.querySelectorAll('#notificationList .dropdown-item').forEach(item => {
                  item.classList.remove('bg-light');
              });
          }
      }).catch(error => {
          console.error('Error marking notifications as read:', error);
      });
});

// Update notification count on page load
function updateNotificationCount() {
  fetch("{% url 'notifications_count' %}")
      .then(response => response.json())
      .then(data => {
          const notificationCount = document.getElementById('notificationCount');
          if (notificationCount) {
              notificationCount.innerText = data.unread_count;
          }
      }).catch(error => {
          console.error('Error updating notification count:', error);
      });
}

// Call the function to initialize count on page load
updateNotificationCount();
});
  </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'new_template/js/jquery.min.js' %}"></script>
    <script src="{% static 'new_template/js/popper.js' %}"></script>
    <script src="{% static 'new_template/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'new_template/js/main.js' %}"></script>
  </body>
</html>