{% load static %}
        
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Dashboard</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="{% static 'admin_dashboard/assets/vendors/feather/feather.css' %}">
    <link rel="stylesheet" href="{% static 'admin_dashboard/assets/vendors/mdi/css/materialdesignicons.min.css' %}">
    <link rel="stylesheet" href="{% static 'admin_dashboard/assets/vendors/ti-icons/css/themify-icons.css' %}">
    <link rel="stylesheet" href="{% static 'admin_dashboard/assets/vendors/font-awesome/css/font-awesome.min.css' %}">
    <link rel="stylesheet" href="{% static 'admin_dashboard/assets/vendors/typicons/typicons.css' %}">
    <link rel="stylesheet" href="{% static 'admin_dashboard/assets/vendors/simple-line-icons/css/simple-line-icons.css' %}">
    <link rel="stylesheet" href="{% static 'admin_dashboard/assets/vendors/css/vendor.bundle.base.css' %}">
    <link rel="stylesheet" href="{% static 'admin_dashboard/assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.css' %}">
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <link rel="stylesheet" href="{% static 'admin_dashboard/assets/vendors/datatables.net-bs4/dataTables.bootstrap4.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'admin_dashboard/assets/js/select.dataTables.min.css' %}">
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="{% static 'admin_dashboard/assets/css/style.css' %}">
    <!-- endinject -->
    <link rel="shortcut icon" href="{% static 'admin_dashboard/assets/images/favicon.png' %}" />
  </head>
  <body class="with-welcome-text">
    <div class="container-scroller">

      <!-- partial:partials/_navbar.html -->
      {% include 'header/header.html'%}
      <!-- partial -->
       
      <div class="container-fluid page-body-wrapper">

        <!-- partial:partials/_sidebar.html -->
         
        {% include 'navbar/navbar.html' %}

        <!-- partial -->

        <div class="main-panel">
            <div class="content-wrapper">
                <div class="row">
                    <div class="container mt-4">
                        <div class="row g-3">
                            <!-- Total Students Card -->
                            <div class="col-md-4 col-sm-6">
                                <div class="card text-center shadow-sm border-0">
                                    <div class="card-body">
                                        <i class="fa fa-users fa-3x mb-3 text-primary"></i>
                                        <h6 class="card-title">Total Students</h6>
                                        <p class="card-text display-5 fw-bold">{{ student_count }}</p>
                                    </div>
                                </div>
                            </div>
        
                            <!-- Total Challenges Card -->
                            <div class="col-md-4 col-sm-6">
                                <div class="card text-center shadow-sm border-0">
                                    <div class="card-body">
                                        <i class="fa fa-flag fa-3x mb-3 text-danger"></i>
                                        <h6 class="card-title">Total Challenges</h6>
                                        <p class="card-text display-5 fw-bold">{{ challenge_count }}</p>
                                    </div>
                                </div>
                            </div>
        
                            <!-- Total Teams Card -->
                            <div class="col-md-4 col-sm-12">
                                <div class="card text-center shadow-sm border-0">
                                    <div class="card-body">
                                        <i class="fa fa-users fa-3x mb-3 text-success"></i>
                                        <h6 class="card-title">Total Teams</h6>
                                        <p class="card-text display-5 fw-bold">{{ team_count }}</p>
                                    </div>
                                </div>
                            </div>
        
                            <!-- Average Success Rate Card -->
                            <div class="col-md-4 col-sm-6">
                                <div class="card text-center shadow-sm border-0">
                                    <div class="card-body">
                                        <i class="fa fa-percent fa-3x mb-3 text-primary"></i>
                                        <h6 class="card-title">Average Success Rate of Challenges Module</h6>
                                        <p class="card-text display-5 fw-bold">{{ average_success_rate|floatformat:2 }}%</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4 col-sm-6">
                                <div class="card text-center shadow-sm border-0">
                                    <div class="card-body">
                                        <i class="fa fa-th-list fa-3x mb-3 text-muted"></i>
                                        <h6 class="card-title">Least Solved Category</h6>
                                        <!-- Display the least solved category -->
                                        <p class="card-text display-5 fw-bold">{{ least_solved_category|default:"N/A" }}</p>
                                    </div>
                                </div>
                            </div>

                        </div>
        
                        <!-- Top Performing Students -->
                        <div class="row mt-4">
                            <div class="col">
                                <div class="card shadow-sm border-0">
                                    <div class="card-body">
                                        <h5 class="card-title">Top Performing Students</h5>
                                        <canvas id="topPerformingStudentsLineChart" style="max-height: 200px;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
        
                        <!-- Top Challenges Combined Bar Chart -->
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="card shadow-sm border-0">
                                    <div class="card-body">
                                        <h5 class="card-title">Top Challenges - Most Correct and Failed Submissions</h5>
                                        <canvas id="topChallengesBarChart" style="max-height: 300px;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
        
                        <!-- Submission Statistics and Charts -->
                        <div class="row mt-4">
                            <!-- Overall Submission Statistics Chart -->
                            <div class="col-md-6 col-sm-12">
                                <div class="card border-0 shadow-2-strong" style="height: 500px;">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title mb-4 text-center">Overall Submission Chart</h5>
                                        <div class="chart-container flex-grow-1 d-flex justify-content-center" style="height: 300px; width: 100%;">
                                            <canvas id="submissionAreaChart" style="max-width: 100%;"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
        
                            <!-- Correct and Failed Submissions by Category Chart -->
                            <div class="col-md-6 col-sm-12">
                                <div class="card border-0 shadow-2-strong" style="height: 500px;">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title mb-4 text-center">Correct and Failed Submissions by Category</h5>
                                        <div class="chart-container flex-grow-1 d-flex justify-content-center" style="height: 300px; width: 100%;">
                                            <canvas id="categoryCorrectSubmissionsChart" style="max-width: 100%;"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                    </div>
                </div>
            </div>
        </div>        
        

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Helper function to create a line chart
    function createLineChart(ctx, labels, datasets, options) {
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: options
        });
    }

    // Helper function to create a bar chart
    function createBarChart(ctx, labels, datasets, options) {
        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: options
        });
    }

    // Top Students Data Preparation
    const topStudents = [
        {% for student in students|slice:":5" %}
            {
                username: "{{ student.user.username }}",
                points: {{ student.points }},
                successRate: {{ student.success_rate|floatformat:2 }}
            },
        {% endfor %}
    ];

    const studentNames = topStudents.map(student => student.username);
    const studentPoints = topStudents.map(student => student.points);
    const studentSuccessRates = topStudents.map(student => student.successRate);

    // Top Performing Students Line Chart
    const ctxTopStudentsLine = document.getElementById('topPerformingStudentsLineChart').getContext('2d');
    createLineChart(ctxTopStudentsLine, studentNames, [
        {
            label: 'Points',
            data: studentPoints,
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderWidth: 2,
            fill: true
        },
        {
            label: 'Success Rate (%)',
            data: studentSuccessRates,
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderWidth: 2,
            fill: true
        }
    ], {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true,
                title: { display: true, text: 'Values' }
            },
            x: {
                title: { display: true, text: 'Students' }
            }
        },
        plugins: {
            legend: { display: true, position: 'top' },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `${context.dataset.label}: ${context.raw}`;
                    }
                }
            }
        },
        layout: { padding: { top: 10, bottom: 10 } }
    });

    // Submission Area Chart Data Preparation
    const submissionData = {{ submission_data|safe }};
    const submissionDates = {{ submission_dates|safe }};

    const submissionAreaChartOptions = {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                title: { display: true, text: 'Number of Submissions' },
                ticks: { stepSize: 1, callback: value => Number.isInteger(value) ? value : '' }
            },
            x: { title: { display: true, text: 'Date' } }
        },
        plugins: {
            legend: { display: true, position: 'top' },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `${context.dataset.label}: ${context.raw.toFixed(2)}`;
                    }
                }
            }
        }
    };

    const ctxSubmissionArea = document.getElementById('submissionAreaChart').getContext('2d');
    createLineChart(ctxSubmissionArea, submissionDates, [{
        label: 'Total Submissions',
        data: submissionData,
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 2,
        fill: true
    }], submissionAreaChartOptions);

    // Category Correct and Failed Submissions Data Preparation
    const categoryData = {{ correct_submission_data|safe }};
    const failedCategoryData = {{ failed_submission_data|safe }};
    const categories = {{ categories|safe }};

    const categoryCorrectFailedOptions = {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                title: { display: true, text: 'Number of Submissions' },
                ticks: { stepSize: 1, callback: value => Number.isInteger(value) ? value : '' }
            }
        },
        plugins: {
            legend: { display: true, position: 'top' },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `${context.dataset.label}: ${context.raw.toFixed(2)}`;
                    }
                }
            }
        }
    };

    const ctxCategoryCorrectFailed = document.getElementById('categoryCorrectSubmissionsChart').getContext('2d');
    createBarChart(ctxCategoryCorrectFailed, categories, [
        {
            label: 'Correct Submissions',
            data: categoryData,
            backgroundColor: 'rgba(75, 192, 192, 0.6)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        },
        {
            label: 'Failed Submissions',
            data: failedCategoryData,
            backgroundColor: 'rgba(255, 99, 132, 0.6)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
        }
    ], categoryCorrectFailedOptions);

    // Top Challenges Data Preparation
    const topCorrectChallenges = [
        {% for challenge in top_correct_challenges %}
            {
                name: "{{ challenge.challenge__name }}",
                correct: {{ challenge.total_correct }},
            },
        {% endfor %}
    ];

    const topFailedChallenges = [
        {% for challenge in top_failed_challenges %}
            {
                name: "{{ challenge.challenge__name }}",
                failed: {{ challenge.total_failed }},
            },
        {% endfor %}
    ];

    // Combining correct and failed challenges data
    const challengeNames = [...new Set([...topCorrectChallenges.map(challenge => challenge.name), ...topFailedChallenges.map(challenge => challenge.name)])];

    const correctData = challengeNames.map(name => {
        const challenge = topCorrectChallenges.find(ch => ch.name === name);
        return challenge ? challenge.correct : 0;
    });

    const failedData = challengeNames.map(name => {
        const challenge = topFailedChallenges.find(ch => ch.name === name);
        return challenge ? challenge.failed : 0;
    });

    // Top Challenges Bar Chart
    const ctxTopChallengesBar = document.getElementById('topChallengesBarChart').getContext('2d');
    createBarChart(ctxTopChallengesBar, challengeNames, [
        {
            label: 'Correct Submissions',
            data: correctData,
            backgroundColor: 'rgba(75, 192, 192, 0.6)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        },
        {
            label: 'Failed Submissions',
            data: failedData,
            backgroundColor: 'rgba(255, 99, 132, 0.6)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
        }
    ], categoryCorrectFailedOptions);
</script>

<script>
    const userId = {{ user.id }};
    const socket = new WebSocket(`ws://${window.location.host}/ws/prof_dashboard/`);

    socket.onopen = function(e) {
        console.log('WebSocket connection established');
    };

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log("Received data: ", data);

        // Update the dashboard with the received data
        document.getElementById('averageSuccessRate').textContent = data.message.average_success_rate;
        // Update student data, submission counts, or any other dashboard info
        // For example:
        data.message.students.forEach((student, index) => {
            const studentElement = document.getElementById(`student_${index}`);
            if (studentElement) {
                studentElement.textContent = `${student.username}: ${student.points} points`;
            }
        });
    };

    socket.onclose = function(e) {
        console.log('WebSocket connection closed');
    };
</script>


  

    <!-- plugins:js -->
    <script src="{% static 'admin_dashboard/assets/vendors/js/vendor.bundle.base.js' %}"></script>
    <script src="{% static 'admin_dashboard/assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.js' %}"></script>
    <!-- endinject -->
    <!-- Plugin js for this page -->
    <script src="{% static 'admin_dashboard/assets/vendors/chart.js/chart.umd.js' %}"></script>
    <script src="{% static 'admin_dashboard/assets/vendors/progressbar.js/progressbar.min.js' %}"></script>
    <!-- End plugin js for this page -->
    <!-- inject:js -->
    <script src="{% static 'admin_dashboard/assets/js/off-canvas.js' %}"></script>
    <script src="{% static 'admin_dashboard/assets/js/template.js' %}"></script>
    <script src="{% static 'admin_dashboard/assets/js/settings.js' %}"></script>
    <script src="{% static 'admin_dashboard/assets/js/hoverable-collapse.js' %}"></script>
    <script src="{% static 'admin_dashboard/assets/js/todolist.js' %}"></script>
    <!-- endinject -->
    <!-- Custom js for this page-->
    <script src="{% static 'admin_dashboard/assets/js/jquery.cookie.js' %}" type="text/javascript"></script>
    <script src="{% static 'admin_dashboard/assets/js/dashboard.js' %}"></script>
    <!-- <script src="assets/js/Chart.roundedBarCharts.js"></script> -->
    <!-- End custom js for this page-->
  </body>
</html>