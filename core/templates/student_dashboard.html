{% load static %}

<!doctype html>
<html lang="en">
<head>
    <title>Students Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Font Awesome 6.0.0-beta3 CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Custom Stylesheet -->
    <link rel="stylesheet" href="{% static 'new_template/css/style.css' %}">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Inline Styles -->
    <style>
        .table-section {
            transition: opacity 0.5s ease-in-out;
        }
        .card {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .card-body {
            padding: 20px;
        }

        .table-container {
            margin-top: 20px;
        }

        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            width: 100%;
            margin: 0 auto;
        }

        #submissionStatsChart {
            max-width: 100%;
            max-height: 100%;
        }
        
        
    </style>
</head>
<body>

<audio id="notificationSound" src="{% static 'notification/notif_update.mp3' %}" preload="auto"></audio>


<div class="wrapper d-flex align-items-stretch">

    <!-- NAVBAR -->
    {% include 'navbar/navbar_students.html' %}

<!-- Page Content -->
<div id="content" class="p-4 p-md-5">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <button type="button" id="sidebarCollapse" class="btn btn-primary">
                <i class="fas fa-bars"></i>
                <span class="sr-only">Toggle Menu</span>
            </button>
            <button class="btn btn-dark d-inline-block d-lg-none ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <span class="navbar-text me-3">Logged in as {{ request.user.username }}</span>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fa fa-bell"></i>
                            <span class="badge bg-danger" id="notificationCount">{{ notifications|length }}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationDropdown" style="width: 350px; max-height: 400px; overflow-y: auto;">
                            <li class="dropdown-header d-flex justify-content-between align-items-center">
                                <strong>Notifications</strong>
                                <a class="text-muted" href="#" id="markAllAsRead">Mark all as read</a>
                            </li>
                            <div id="notificationList">
                                {% for notification in notifications %}
                                <li class="dropdown-item {% if not notification.is_read %}bg-light{% endif %}" style="white-space: normal; word-wrap: break-word; word-break: break-word;">
                                    <p class="mb-1">
                                        <strong>From: {{ notification.sender.username }}</strong><br>
                                        {{ notification.message }}
                                    </p>
                                    <small class="text-muted">{{ notification.created_at }}</small>
                                </li>
                                {% empty %}
                                <li class="dropdown-item">No notifications.</li>
                                {% endfor %}
                            </div>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- Container for main dashboard content -->
    {% if config.show_leaderboards %}
    <div class="container mt-4">
        
                <!-- Leaderboards Section -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Leaderboards</h5>
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-hover table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th scope="col" style="position: sticky; top: 0; z-index: 1;">#</th>
                                                <th scope="col" style="position: sticky; top: 0; z-index: 1;">Alias</th>
                                                <th scope="col" style="position: sticky; top: 0; z-index: 1;">Points</th>
                                                <th scope="col" style="position: sticky; top: 0; z-index: 1;">Completed Challenges</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for student in students %}
                                            <tr>
                                                <th scope="row">
                                                    {{ forloop.counter }}
                                                    {% if forloop.first %}
                                                        <i class="bi bi-award-fill text-warning"></i> <!-- Crown for top user -->
                                                    {% endif %}
                                                </th>
                                                <td>{{ student.alias }}</td>
                                                <td>{{ student.points }}</td>
                                                <td>{{ student.completed_challenges_count }}</td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="4" class="text-center">No users available.</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        {% endif %}

        {% if config.show_team_scores %}
        <!-- Team Scores Section -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Team Scores (From Completed Team Challenges)</h5>
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Team Name</th>
                                        <th scope="col">Total Points (Team Challenges)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for team, score in ranked_teams %}
                                    <tr>
                                        <th scope="row">{{ forloop.counter }}</th>
                                        <td>{{ team.name }}</td>
                                        <td>{{ score }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center">No teams available.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <!-- Header Section -->
                            <h5 class="card-title text-left mb-4 text-primary">Submission Activity Overview</h5>

                            <!-- Summary Section -->
                            <div class="summary-section mb-4">
                                <!-- Challenge Comparison Section -->
                                <div class="row mb-3">
                                    <div class="col-md-4 text-center">
                                        <div class="card shadow-sm h-100">
                                            <div class="card-body">
                                                <h6 class="text-success">
                                                    <i class="fas fa-check-circle"></i> Highest Correct Challenge
                                                </h6>
                                                <p class="mb-1"><strong>{{ highest_correct.challenge__name|default:"N/A" }}</strong></p>
                                                <p>{{ highest_correct.count|default:0 }} submissions</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <div class="card shadow-sm h-100">
                                            <div class="card-body">
                                                <h6 class="text-danger">
                                                    <i class="fas fa-times-circle"></i> Highest Incorrect Challenge
                                                </h6>
                                                <p class="mb-1"><strong>{{ highest_incorrect.challenge__name|default:"N/A" }}</strong></p>
                                                <p>{{ highest_incorrect.count|default:0 }} submissions</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <div class="card shadow-sm h-100">
                                            <div class="card-body">
                                                <h6 class="text-warning">
                                                    <i class="fas fa-lightbulb"></i> Challenge to Improve
                                                </h6>
                                                <p><strong>{{ challenge_to_improve.challenge.name|default:"No recent incorrect submissions" }}</strong></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr>

                                <!-- Student Activity Performance Section -->
                                <h6 class="text-center text-secondary mb-3">Activity Performance</h6>
                                <div class="row">
                                    <!-- Correct Attempts Progress Bar -->
                                    <div class="col-md-6 mb-3 mb-md-0">
                                        <div class="card shadow-sm">
                                            <div class="card-body">
                                                <p><strong>Correct Answers:</strong> <span class="text-success">{{ activity_correct_attempts }}</span> attempts</p>
                                                <div class="progress mb-2" style="height: 15px;">
                                                    <div class="progress-bar bg-success" role="progressbar"
                                                        style="width: {{ activity_correct_attempts|floatformat:0 }}%;"
                                                        aria-valuenow="{{ activity_correct_attempts }}"
                                                        aria-valuemin="0"
                                                        aria-valuemax="{{ total_activities_attempted }}">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Incorrect Attempts Progress Bar -->
                                    <div class="col-md-6 mb-3 mb-md-0">
                                        <div class="card shadow-sm">
                                            <div class="card-body">
                                                <p><strong>Incorrect Answers:</strong> <span class="text-danger">{{ activity_incorrect_attempts }}</span> attempts</p>
                                                <div class="progress mb-2" style="height: 15px;">
                                                    <div class="progress-bar bg-danger" role="progressbar"
                                                        style="width: {{ activity_incorrect_attempts|floatformat:0 }}%;"
                                                        aria-valuenow="{{ activity_incorrect_attempts }}"
                                                        aria-valuemin="0"
                                                        aria-valuemax="{{ total_activities_attempted }}">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Performance Ratio Section -->
                                <div class="row text-center mt-4">
                                    <div class="col-md-6 mb-3 mb-md-0">
                                        <div class="card shadow-sm">
                                            <div class="card-body">
                                                <h6>Activity Performance Percentage</h6>
                                                <p>
                                                    <span class="badge bg-success" style="font-size: 1rem;">{{ activity_performance_ratio|floatformat:2 }}%</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3 mb-md-0">
                                        <div class="card shadow-sm">
                                            <div class="card-body">
                                                <h6>Challenge Performance Percentage</h6>
                                                <p>
                                                    <span class="badge bg-primary" style="font-size: 1rem;">{{ challenge_performance_ratio|floatformat:2 }}%</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <hr>

                                <!-- Comparison Insight Section -->
                                <div class="text-left mt-3">
                                    {% if total_attempts == 0 and total_activities_attempted == 0 %}
                                        <p class="text-secondary">
                                            <i class="fas fa-info-circle"></i> No data available.
                                        </p>
                                    {% elif activity_performance_ratio > challenge_performance_ratio %}
                                        <p class="text-success">
                                            <i class="fas fa-thumbs-up"></i> Great job! Your activity performance is stronger than your challenge performance. 
                                            Focus on practicing more challenges to balance your overall success.
                                        </p>
                                        <p class="text-info">
                                            Consider reviewing strategies and solving past challenge problems to enhance your challenge performance.
                                        </p>
                                    {% elif activity_performance_ratio < challenge_performance_ratio %}
                                        <p class="text-warning">
                                            <i class="fas fa-exclamation-circle"></i> Your challenge performance is better than your activity responses. 
                                            Improving activity performance could strengthen your foundational understanding.
                                        </p>
                                        <p class="text-info">
                                            Try revisiting lessons and practicing more activities to enhance your understanding and accuracy.
                                        </p>
                                    {% else %}
                                        <p class="text-primary">
                                            <i class="fas fa-balance-scale"></i> Your performance is balanced between activities and challenges. 
                                            Keep maintaining consistent progress in both areas to achieve excellence.
                                        </p>
                                    {% endif %}
                                </div>
                            </div>






                        <!-- Toggle Button -->
                        <div class="text-center">
                            <button class="btn btn-primary toggle-table mt-3">View Activity Submission</button>
                        </div>

                    </div>
        
                    
        
                    <!-- Detailed Table Section -->
                    <div class="table-section" style="display: none; opacity: 0; transition: opacity 0.5s;">
                        <!-- Added container for horizontal padding and responsiveness -->
                        <div class="container-fluid px-3">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-hover table-striped">
                                    <thead class="table-dark">
                                        <tr>
                                            <th scope="col">#</th>
                                            <th scope="col">Challenge Name</th>
                                            <th scope="col">Status</th>
                                            <th scope="col">Score Obtained</th>
                                            <th scope="col">Submission Time</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for submission in submissions %}
                                            <tr>
                                                <th scope="row">{{ forloop.counter }}</th>
                                                <td>{{ submission.challenge.name }}</td>
                                                <td>
                                                    {% if submission.is_correct %}
                                                        <span class="badge bg-success">Correct</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">Incorrect</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if submission.is_correct %}
                                                        {{ submission.challenge.points }}
                                                    {% else %}
                                                        0
                                                    {% endif %}
                                                </td>
                                                <td>{{ submission.submission_time|date:"F j, Y, g:i A" }}</td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="5" class="text-center">No submission activity available.</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Footer Section with consistent spacing -->
                        <div class="container-fluid px-3 mt-2">
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Total Score of the User:</strong></td>
                                    <td><strong>{{ total_score }}</strong></td>
                                </tr>
                            </tfoot>
                        </div>
                    </div>
        </div>
        


        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Lesson Progress</h5>
                        <!-- Loop through the lessons by category and show progress -->
                        {% for category, data in lessons_by_category.items %}
                       
                        <hr>        
                        <!-- Show overall progress bar for this category -->
                        <div class="mb-3">
                            <p>{{ category|upper }} - Progress</p>
        
                            <!-- Display overall progress bar for this category -->
                            <div class="progress">
                                <div class="progress-bar {% if data.completion_percentage == 100 %}bg-success{% elif data.completion_percentage >= 75 %}bg-info{% elif data.completion_percentage >= 50 %}bg-warning{% else %}bg-danger{% endif %}" role="progressbar" style="width: {{ data.completion_percentage }}%" aria-valuenow="{{ data.completion_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
        
                            <small>{{ data.completion_percentage|floatformat:0 }}% completed</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        
        
           
        
        
        <!-- Cards Section -->
        <div class="row mb-4">
            <!-- Total Lessons Available Card -->
            <div class="col-md-6 mb-4">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <i class="fas fa-book fa-3x mb-2"></i> <!-- Icon -->
                        <h5 class="card-title">Number of Lessons Available</h5>
                        <p class="display-6 fw-bold">{{ lesson_count }}</p>
                    </div>
                </div>
            </div>

            <!-- Challenges Available Card -->
            <div class="col-md-6 mb-4">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <i class="fas fa-trophy fa-3x mb-2"></i> <!-- Icon -->
                        <h5 class="card-title">Number of Challenges Available</h5>
                        <p class="display-6 fw-bold">{{ challenge_count }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Attempts and Challenges Completed Cards -->
        <div class="row mb-4">
            <!-- Challenges Completed Card -->
            <div class="col-md-6 mb-4">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <i class="fas fa-trophy fa-3x mb-2"></i> <!-- Icon -->
                        <h5 class="card-title">Challenges Completed</h5>
                        <p class="display-6 fw-bold">{{ completed_challenges_count }}</p>
                    </div>
                </div>
            </div>

            <!-- Points Earned Card -->
            <div class="col-md-6 mb-4">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <i class="fas fa-coins fa-3x mb-2"></i> <!-- Icon -->
                        <h5 class="card-title">Total Points Earned</h5>
                        <p class="display-6 fw-bold">{{ total_points }}</p> <!-- Display the points -->
                    </div>
                </div>
            </div>
        </div>


        

        {% if config.show_submission_overview_chart %}
        <!-- Submission Overview Chart Card -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Submission Overview Correct & Incorrect</h5>
                        <div class="chart-container" style="position: relative; height: 400px;">
                            <canvas id="submissionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    

    

        {% if config.show_report_and_stats %}
<!-- Report and Submission Stats Section -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Analysis of the Performance of the Student</h5>

                <!-- Report Section -->
                <div class="mb-4" style="text-align: justify; text-align-last: left;">
                    {{ analysis|linebreaks|safe }} <!-- Converts newlines to <br> tags -->
                </div>

                <!-- Suggested Lesson -->
                {% if suggested_lesson %}
                <div class="mb-4">
                    <h6>Suggested Lesson</h6>
                    <p>
                        <a href="{% url 'lesson_detail' suggested_lesson.id %}">
                            {{ suggested_lesson.name }}
                        </a>: {{ suggested_lesson.description }}
                    </p>
                </div>
                {% endif %}

                <!-- Submission Stats Section -->
                <div class="mb-4">
                    <h6>Your Submission Stats</h6>
                    {% if correct_submissions|add:failed_submissions %}
                    <div class="chart-container" style="position: relative; height: 400px;">
                        <canvas id="submissionStatsChart"></canvas>
                    </div>
                    {% else %}
                    <p>No submission data available.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Cybersecurity Trends Section -->
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Recommended Cybersecurity Trends</h5>
                <ul>
                    {% if trends %}
                        {% for trend in trends %}
                            <li>{{ trend }}</li>
                        {% endfor %}
                    {% else %}
                        <li>No current trends available.</li>
                    {% endif %}
                </ul>
            </div>
        </div>


        <p><strong>Last Report Date:</strong> 
            <span id="last-report-date">
                {% if last_analysis_update %}
                    {{ last_analysis_update|date:"F j, Y, g:i a" }}
                {% else %}
                    Not available
                {% endif %}
            </span>
        </p>

    </div>
</div>
{% endif %}


<script>
    document.addEventListener("DOMContentLoaded", () => {
        const toggleButton = document.querySelector(".toggle-table");
        const tableSection = document.querySelector(".table-section");
    
        toggleButton.addEventListener("click", () => {
            if (tableSection.style.display === "none") {
                tableSection.style.display = "block";
                setTimeout(() => {
                    tableSection.style.opacity = "1";
                }, 50); // Small delay for smooth fade-in
                toggleButton.textContent = "Hide Activity Submission";
            } else {
                tableSection.style.opacity = "0";
                setTimeout(() => {
                    tableSection.style.display = "none";
                }, 500); // Match with CSS transition duration
                toggleButton.textContent = "View Activity Submission";
            }
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        fetch("{% url 'submission_data' %}")  // Ensure the URL matches your view
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('submissionChart').getContext('2d');
                const submissionChart = new Chart(ctx, {
                    type: 'line',  // Changed to 'line' for a line chart
                    data: {
                        labels: data.dates,
                        datasets: [{
                            label: 'Total Submissions',
                            data: data.counts,
                            fill: false,  // Do not fill the area under the line
                            backgroundColor: 'rgba(75, 192, 192, 0.2)', // Light fill color for points
                            borderColor: 'rgba(75, 192, 192, 1)', // Line color
                            borderWidth: 2,
                            tension: 0.1 // Smoothing the line (optional)
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Submissions'
                                },
                                ticks: {
                                    stepSize: 1, // Ensure step size is 1 for whole numbers
                                    callback: function(value) {
                                        return Number.isInteger(value) ? value : ''; // Show only whole numbers
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.raw;
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error('Error fetching submission data:', error));
    });
</script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize the chart if submissions exist
            {% if correct_submissions|add:failed_submissions %}
            const ctx = document.getElementById('submissionStatsChart')?.getContext('2d');
            if (ctx) {
                const submissionStatsChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Correct Submissions', 'Failed Submissions'],
                        datasets: [{
                            label: 'Submission Stats',
                            data: [{{ correct_submissions }}, {{ failed_submissions }}],
                            backgroundColor: ['#4CAF50', '#FF5252'],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (tooltipItem) {
                                        const total = tooltipItem.dataset.data.reduce((sum, value) => sum + value, 0);
                                        const value = tooltipItem.raw;
                                        const percentage = ((value / total) * 100).toFixed(2);
                                        return `${tooltipItem.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            {% endif %}
        
            // WebSocket URL (Use wss if the site uses HTTPS)
        const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        let notificationSocket = createWebSocketConnection();
        let reconnectInterval;

        // Function to establish WebSocket connection
        function createWebSocketConnection() {
            const socket = new WebSocket(
                `${wsProtocol}://${window.location.host}/ws/notifications/`
            );

            // Handle incoming WebSocket messages
            socket.onmessage = function (e) {
                console.log(e.data);
                const data = JSON.parse(e.data);
                const notificationList = document.getElementById('notificationList');
                if (!notificationList) return; // Exit if notification list is not available

                // Create new notification element
                const newNotification = document.createElement('li');
                newNotification.classList.add('dropdown-item');
                newNotification.style.whiteSpace = 'normal';  // Ensure text wraps
                newNotification.style.wordBreak = 'break-word'; // Prevent horizontal scroll

                newNotification.innerHTML = `
                    <p class="mb-1">
                        <strong>From: ${data.sender}</strong><br>${data.message}
                    </p>
                    <small class="text-muted">${new Date(data.created_at).toLocaleString()}</small>
                `;

                // Add new notification to the top of the list
                notificationList.prepend(newNotification);

                // Update the notification count
                const notificationCount = document.getElementById('notificationCount');
                if (notificationCount) {
                    notificationCount.textContent = parseInt(notificationCount.textContent) + 1;
                }

                // Play the notification sound
                const notificationSound = document.getElementById('notificationSound');
                if (notificationSound) {
                    notificationSound.play();
                }
            };

            // WebSocket onclose event with reconnection logic
            socket.onclose = function (e) {
                console.error('Notification socket closed unexpectedly. Attempting to reconnect...');
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(function () {
                        console.log('Reconnecting WebSocket...');
                        notificationSocket = createWebSocketConnection();
                    }, 5000);  // Try to reconnect every 5 seconds
                }
            };

            // On successful connection, clear the reconnect interval
            socket.onopen = function () {
                console.log('WebSocket connection established.');
                clearInterval(reconnectInterval);
                reconnectInterval = null;  // Reset the interval
            };

            return socket;
        }

        // Mark all notifications as read
        document.getElementById('markAllAsRead')?.addEventListener('click', function (e) {
            e.preventDefault();
            fetch("{% url 'mark_all_notifications_as_read' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            }).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the notification count to 0
                        const notificationCount = document.getElementById('notificationCount');
                        if (notificationCount) {
                            notificationCount.innerText = '0';
                        }
                        // Remove highlight from the notification list
                        document.querySelectorAll('#notificationList .dropdown-item').forEach(item => {
                            item.classList.remove('bg-light');
                        });
                    }
                }).catch(error => {
                    console.error('Error marking notifications as read:', error);
                });
        });

        // Update notification count on page load
        function updateNotificationCount() {
            fetch("{% url 'notifications_count' %}")
                .then(response => response.json())
                .then(data => {
                    const notificationCount = document.getElementById('notificationCount');
                    if (notificationCount) {
                        notificationCount.innerText = data.unread_count;
                    }
                }).catch(error => {
                    console.error('Error updating notification count:', error);
                });
        }

        // Call the function to initialize count on page load
        updateNotificationCount();
    });
    </script>
    

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'new_template/js/jquery.min.js' %}"></script>
    <script src="{% static 'new_template/js/popper.js' %}"></script>
    <script src="{% static 'new_template/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'new_template/js/main.js' %}"></script>

</div>
</body>
</html>