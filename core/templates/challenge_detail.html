{% load static %}

<!doctype html>
<html lang="en">
<head>
    <title>Challenges</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Font Awesome 6.0.0-beta3 CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <link rel="stylesheet" href="{% static 'new_template/css/style.css' %}">

    <style>
        .floating-alert {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050; /* Ensure it appears above other elements */
            width: 300px; /* Adjust width as needed */
        }
      </style>

</head>
<body>
    
<audio id="notificationSound" src="{% static 'notification/notif_update.mp3' %}" preload="auto"></audio>

<div class="wrapper d-flex align-items-stretch">
    <!-- SIDEBAR -->
    {% include 'navbar/navbar_students.html' %}

    <!-- Page Content  -->
    <div id="content" class="p-4 p-md-5">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <button type="button" id="sidebarCollapse" class="btn btn-primary">
                    <i class="fa fa-bars"></i>
                </button>
                <button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <i class="fa fa-bars"></i>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <span class="navbar-text me-3">Logged in as {{ request.user.username }}</span>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fa fa-bell"></i>
                                <span class="badge bg-danger" id="notificationCount">{{ notifications|length }}</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationDropdown" style="width: 350px; max-height: 400px; overflow-y: auto;">
                                <li class="dropdown-header d-flex justify-content-between align-items-center">
                                    <strong>Notifications</strong>
                                    <a class="text-muted" href="#" id="markAllAsRead">Mark all as read</a>
                                </li>
                                <div id="notificationList">
                                    {% for notification in notifications %}
                                    <li class="dropdown-item {% if not notification.is_read %}bg-light{% endif %}" style="white-space: normal; word-wrap: break-word; word-break: break-word;">
                                        <p class="mb-1">
                                            <strong>From: {{ notification.sender.username }}</strong><br>
                                            {{ notification.message }}
                                        </p>
                                        <small class="text-muted">{{ notification.created_at }}</small>
                                    </li>
                                    {% empty %}
                                    <li class="dropdown-item">No notifications.</li>
                                    {% endfor %}
                                </div>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        {% block content %}
<div class="container mt-4">
    <h2 class="mb-4">{{ challenge.name }}</h2>
    <div class="card">
        <div class="card-body">
            <!-- Instruction Section -->
            <div class="alert alert-info">
                <h5>Challenge Details</h5>
                <p>
                    {% if challenge.scoring_type == 'team' %}
                        <strong>This is a Team Challenge:</strong>
                        <p>In this challenge, points will be awarded to the entire team when any team member submits the correct flag. However, only the individual who submits the correct flag will receive recognition for their submission. It's important to collaborate with your teammates for the best results!</p>
                    {% else %}
                        <strong>This is an Individual Challenge:</strong>
                        <p>For this challenge, points will be awarded only to the individual who submits the correct flag. This is an opportunity to work independently and improve your personal score.</p>
                    {% endif %}
                </p>
            </div>

            <!-- Hints Section with Tabs -->
            {% if hints %}
            <ul class="nav nav-tabs" id="hintsTab" role="tablist">
                {% for hint in hints %}
                <li class="nav-item">
                    <a class="nav-link {% if forloop.first %}active{% endif %}" id="hint{{ forloop.counter }}-tab"
                       data-bs-toggle="tab" href="#hint{{ forloop.counter }}" role="tab"
                       aria-controls="hint{{ forloop.counter }}"
                       aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                       Hint {{ forloop.counter }}
                    </a>
                </li>
                {% endfor %}
            </ul>
            <div class="tab-content mt-3" id="hintsTabContent">
                {% for hint in hints %}
                <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="hint{{ forloop.counter }}"
                     role="tabpanel" aria-labelledby="hint{{ forloop.counter }}-tab">
                    <p class="card-text" style="font-size: 1.25rem; font-weight: bold;">{{ hint }}</p>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>No hints available.</p>
            {% endif %}

            <!-- Challenge Content -->
            <div class="card-text" id="challenge-content">{{ challenge.content|safe }}</div>
            <p class="card-text">Points: <strong>{{ challenge.points }}</strong></p>
            <p class="card-text">Link: <a href="{{ challenge.link }}" target="_blank">{{ challenge.link }}</a></p>

            {% if challenge.file %}
            <p class="card-text">File: <a href="{{ challenge.file.url }}" download>Download</a></p>
            {% endif %}

            <!-- Challenge Completion Status -->
            {% if completed %}
            <p class="text-success">
                You have already completed this challenge. You cannot submit the flag again.
            </p>
            {% else %}
            <!-- Flag Submission Form -->
            <form method="POST" action="{% url 'submit_flag' challenge.id %}">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="flag_submission" class="form-label">Flag Submission</label>
                    <input type="text" class="form-control" id="flag_submission" name="flag"
                           placeholder="TIP{YoUr @n$w3r}" {% if disable_submit %}disabled{% endif %} required>
                </div>
                <button type="submit" class="btn btn-primary" {% if disable_submit %}disabled{% endif %}>
                    Submit Flag
                </button>
            </form>
            {% endif %}

            {% if disable_submit %}
            <p class="text-danger">You cannot submit this challenge because you have left the team that completed it.</p>
            {% endif %}
        </div>
        <!-- Footer with Deadline -->
        <div class="card-footer text-muted">
            {% if challenge.deadline %}
            Deadline: {{ challenge.deadline|date:"F j, Y g:i a" }}
            {% else %}
            No deadline
            {% endif %}
        </div>
    </div>
        
        <script>
            // Initialize TinyMCE on the challenge content div
            tinymce.init({
                selector: '#challenge-content',
                menubar: false,
                toolbar: 'undo redo | bold italic | alignleft aligncenter alignright alignjustify | outdent indent',
                readonly: true // Make it read-only if you only want to display content
            });
        </script>
        {% endblock %}

        {% include 'notification/student_notification.html' %}
        
        

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // WebSocket URL (Use wss if the site uses HTTPS)
                const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
                let notificationSocket = null;
                let reconnectInterval = null;
        
                // Function to establish WebSocket connection
                function createWebSocketConnection() {
                    notificationSocket = new WebSocket(`${wsProtocol}://${window.location.host}/ws/notifications/`);
        
                    // Handle incoming WebSocket messages
                    notificationSocket.onmessage = function (e) {
                        const data = JSON.parse(e.data);
                        const notificationList = document.getElementById('notificationList');
                        if (!notificationList) return; // Exit if notification list is not available
        
                        // Create new notification element
                        const newNotification = document.createElement('li');
                        newNotification.classList.add('dropdown-item');
                        newNotification.style.whiteSpace = 'normal';
                        newNotification.style.wordBreak = 'break-word';
                        newNotification.innerHTML = `
                            <p class="mb-1">
                                <strong>From: ${data.sender}</strong><br>${data.message}
                            </p>
                            <small class="text-muted">${new Date(data.created_at).toLocaleString()}</small>
                        `;
        
                        // Add new notification to the top of the list
                        notificationList.prepend(newNotification);
        
                        // Update the notification count
                        const notificationCount = document.getElementById('notificationCount');
                        if (notificationCount) {
                            notificationCount.textContent = parseInt(notificationCount.textContent) + 1;
                        }
        
                        // Play the notification sound
                        const notificationSound = document.getElementById('notificationSound');
                        if (notificationSound) {
                            notificationSound.play();
                        }
                    };
        
                    // WebSocket onclose event with reconnection logic
                    notificationSocket.onclose = function (e) {
                        console.error('Notification socket closed unexpectedly. Attempting to reconnect...');
                        if (!reconnectInterval) {
                            reconnectInterval = setInterval(function () {
                                console.log('Reconnecting WebSocket...');
                                notificationSocket = createWebSocketConnection();
                            }, 5000); // Try to reconnect every 5 seconds
                        }
                    };
        
                    // On successful connection, clear the reconnect interval
                    notificationSocket.onopen = function () {
                        console.log('WebSocket connection established.');
                        clearInterval(reconnectInterval);
                        reconnectInterval = null;
                    };
                }
        
                // Initialize WebSocket connection
                createWebSocketConnection();
        
                // Mark all notifications as read
                document.getElementById('markAllAsRead')?.addEventListener('click', function (e) {
                    e.preventDefault();
                    fetch("{% url 'mark_all_notifications_as_read' %}", {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({})
                    }).then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Update the notification count to 0
                                const notificationCount = document.getElementById('notificationCount');
                                if (notificationCount) {
                                    notificationCount.innerText = '0';
                                }
        
                                // Remove highlight from the notification list
                                document.querySelectorAll('#notificationList .dropdown-item').forEach(item => {
                                    item.classList.remove('bg-light');
                                });
                            }
                        }).catch(error => {
                            console.error('Error marking notifications as read:', error);
                        });
                });
        
                // Update notification count on page load
                function updateNotificationCount() {
                    fetch("{% url 'notifications_count' %}")
                        .then(response => response.json())
                        .then(data => {
                            const notificationCount = document.getElementById('notificationCount');
                            if (notificationCount) {
                                notificationCount.innerText = data.unread_count;
                            }
                        }).catch(error => {
                            console.error('Error updating notification count:', error);
                        });
                }
        
                // Call the function to initialize count on page load
                updateNotificationCount();
            });
        </script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'new_template/js/jquery.min.js' %}"></script>
<script src="{% static 'new_template/js/popper.js' %}"></script>
<script src="{% static 'new_template/js/bootstrap.min.js' %}"></script>
<script src="{% static 'new_template/js/main.js' %}"></script>
</body>
</html>