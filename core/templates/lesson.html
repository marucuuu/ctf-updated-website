{% load static %}

<!doctype html>
<html lang="en">
<head>
    <title>Lesson</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Font Awesome 6.0.0-beta3 CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Custom Stylesheet -->
    <link rel="stylesheet" href="{% static 'new_template/css/style.css' %}">

</head>
<body>

    <audio id="notificationSound" src="{% static 'notification/notif_update.mp3' %}" preload="auto"></audio>
    
    <div class="wrapper d-flex align-items-stretch">
        
      <!-- NAVBAR  -->
      {% include 'navbar/navbar_students.html' %}

        <!-- Page Content  -->
        <div id="content" class="p-4 p-md-5">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <button type="button" id="sidebarCollapse" class="btn btn-primary">
                        <i class="fa fa-bars"></i>
                        <span class="sr-only">Toggle Menu</span>
                    </button>
                    <button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                        <i class="fa fa-bars"></i>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="nav navbar-nav ml-auto">
                            <li class="nav-item">
                                <span class="navbar-text mr-3">Logged in as {{ request.user.username }}</span>
                            </li>

                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fa fa-bell"></i>
                                    <span class="badge bg-danger" id="notificationCount">{{ notifications|length }}</span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationDropdown" style="width: 350px; max-height: 400px; overflow-y: auto;">
                                    <li class="dropdown-header d-flex justify-content-between align-items-center">
                                        <strong>Notifications</strong>
                                        <a class="text-muted" href="#" id="markAllAsRead">Mark all as read</a>
                                    </li>
                                    <div id="notificationList">
                                        {% for notification in notifications %}
                                        <li class="dropdown-item {% if not notification.is_read %}bg-light{% endif %}" style="white-space: normal; word-wrap: break-word; word-break: break-word;">
                                            <p class="mb-1">
                                                <strong>From: {{ notification.sender.username }}</strong><br>
                                                {{ notification.message }}
                                            </p>
                                            <small class="text-muted">{{ notification.created_at }}</small>
                                        </li>
                                        {% empty %}
                                        <li class="dropdown-item">No notifications.</li>
                                        {% endfor %}
                                    </div>
                                </ul>
                            </li>
                            
                        </ul>
                    </div>
                </div>
            </nav>

            {% block content %}
            <div class="container mt-4">
                <h2 class="mb-4">Lessons</h2>
                
                <!-- General Description for Lessons -->
                <div class="mb-4 bg-dark text-white p-4">
                    <p>Welcome to the Lessons section! Here, you'll find a variety of lessons organized into categories to help you navigate through each topic. These lessons are designed to break down complex concepts into manageable pieces, ensuring you can understand them clearly and effectively.</p>
                
                    <p><strong>Instructions:</strong></p>
                    <p>Start by completing each lesson module carefully. It’s important to go through the entire lesson to get a solid understanding of the concepts before moving on to the next. Once you’ve completed all lessons in a specific category, you’ll unlock the practice tests associated with that category. These challenges will help reinforce what you’ve learned, so make sure you finish the lessons before attempting the tests. As you progress, the lessons you complete will be highlighted, allowing you to easily track your progress and see how much you’ve accomplished. To dive into a lesson, simply click on the "View Lesson" button. Feel free to revisit previous lessons at any time, but remember that practice tests become available only after you’ve completed the related lessons.</p>
                </div>

                <!-- Lessons Display -->
                <div class="row">
                    {% for category, lessons in lessons_by_category.items %}
                    <div class="col-12 mb-4">
                        <h3>{{ category|upper }}</h3>
                        <div class="row">
                            {% for lesson in lessons %}
                            <div class="col-md-4 mb-4">
                                <!-- Add 'bg-light-green' class if the lesson has been read, 'bg-light' if not -->
                                <div class="card h-100 
                                    {% if lesson in user.userprofile.read_lessons.all %}
                                        bg-light-green
                                    {% else %}
                                        bg-light
                                    {% endif %}">
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title">
                                            <!-- Render the lesson name as WYSIWYG content -->
                                            {{ lesson.name|safe }}
                                        </h5>
                                        <p class="card-text">{{ lesson.description|slice:":200" }}{% if lesson.description|length > 200 %}...{% endif %}</p>
                                        <div class="mt-auto">
                                            <a href="{% url 'lesson_detail' lesson.id %}" class="btn btn-primary">View Lesson</a>
                                        </div>
                                    </div>
                                    <div class="card-footer text-muted">
                                        Published on {{ lesson.publish_date }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endblock %}

            
            
            <script>
                document.addEventListener('DOMContentLoaded', function () {  
                    // WebSocket URL (Use wss if the site uses HTTPS)
        const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        let notificationSocket = createWebSocketConnection();
        let reconnectInterval;

        // Function to establish WebSocket connection
        function createWebSocketConnection() {
            const socket = new WebSocket(
                `${wsProtocol}://${window.location.host}/ws/notifications/`
            );

            // Handle incoming WebSocket messages
            socket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                const notificationList = document.getElementById('notificationList');
                if (!notificationList) return; // Exit if notification list is not available

                // Create new notification element
                const newNotification = document.createElement('li');
                newNotification.classList.add('dropdown-item');
                newNotification.style.whiteSpace = 'normal';  // Ensure text wraps
                newNotification.style.wordBreak = 'break-word'; // Prevent horizontal scroll

                newNotification.innerHTML = `
                    <p class="mb-1">
                        <strong>From: ${data.sender}</strong><br>${data.message}
                    </p>
                    <small class="text-muted">${new Date(data.created_at).toLocaleString()}</small>
                `;

                // Add new notification to the top of the list
                notificationList.prepend(newNotification);

                // Update the notification count
                const notificationCount = document.getElementById('notificationCount');
                if (notificationCount) {
                    notificationCount.textContent = parseInt(notificationCount.textContent) + 1;
                }

                // Play the notification sound
                const notificationSound = document.getElementById('notificationSound');
                if (notificationSound) {
                    notificationSound.play();
                }
            };

            // WebSocket onclose event with reconnection logic
            socket.onclose = function (e) {
                console.error('Notification socket closed unexpectedly. Attempting to reconnect...');
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(function () {
                        console.log('Reconnecting WebSocket...');
                        notificationSocket = createWebSocketConnection();
                    }, 5000);  // Try to reconnect every 5 seconds
                }
            };

            // On successful connection, clear the reconnect interval
            socket.onopen = function () {
                console.log('WebSocket connection established.');
                clearInterval(reconnectInterval);
                reconnectInterval = null;  // Reset the interval
            };

            return socket;
        }

        // Mark all notifications as read
        document.getElementById('markAllAsRead')?.addEventListener('click', function (e) {
            e.preventDefault();
            fetch("{% url 'mark_all_notifications_as_read' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            }).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the notification count to 0
                        const notificationCount = document.getElementById('notificationCount');
                        if (notificationCount) {
                            notificationCount.innerText = '0';
                        }
                        // Remove highlight from the notification list
                        document.querySelectorAll('#notificationList .dropdown-item').forEach(item => {
                            item.classList.remove('bg-light');
                        });
                    }
                }).catch(error => {
                    console.error('Error marking notifications as read:', error);
                });
        });

        // Update notification count on page load
        function updateNotificationCount() {
            fetch("{% url 'notifications_count' %}")
                .then(response => response.json())
                .then(data => {
                    const notificationCount = document.getElementById('notificationCount');
                    if (notificationCount) {
                        notificationCount.innerText = data.unread_count;
                    }
                }).catch(error => {
                    console.error('Error updating notification count:', error);
                });
        }

        // Call the function to initialize count on page load
        updateNotificationCount();
    });
            </script>

            <!-- Bootstrap Bundle with Popper -->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
            <script src="{% static 'new_template/js/jquery.min.js' %}"></script>
            <script src="{% static 'new_template/js/popper.js' %}"></script>
            <script src="{% static 'new_template/js/bootstrap.min.js' %}"></script>
            <script src="{% static 'new_template/js/main.js' %}"></script>
</body>
</html>
